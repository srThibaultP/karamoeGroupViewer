<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Playlist Karaoke Mugen</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #playlistDescription {
            font-style: italic;
            margin-bottom: 15px;
        }

        .user-section {
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 5px;
            overflow: hidden;
        }

        .user-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .kara-container {
            margin-left: 20px;
            margin-top: 5px;
            display: none;
            transition: all 0.3s ease;
        }

        .kara-item {
            border-left: 2px solid #ccc;
            padding-left: 10px;
            margin-bottom: 5px;
        }

.over { color: #e74c3c; }   /* rouge pour dépassement */
.ok { color: #6abf69; }     /* vert doux pour OK */
.zero { color: #b0b0b0; }   /* gris clair pour zéro */


        .toggle-btn {
            background: none;
            border: none;
            font-size: 1em;
            cursor: pointer;
        }

        .kara-title {
            font-weight: bold;
        }

        .kara-info {
            font-size: 0.9em;
            color: #555;
        }

        .tag {
            background: #eee;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.75em;
            margin-right: 3px;
        }

        .version-tag {
            font-style: italic;
            font-size: 0.85em;
            color: #0077cc;
            margin-left: 5px;
        }

        #searchInput {
            margin-bottom: 10px;
            width: 300px;
            padding: 5px;
        }

        .multi-user-line {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .time-bar-container {
            background: #eee;
            height: 15px;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }

        .time-bar {
            height: 100%;
            width: 0;
            transition: width 0.5s ease;
        }
    </style>
</head>

<body>
    <h1>Lecture de Playlist Karaoke Mugen</h1>
    <p id="playlistDescription"></p>

    <input type="file" id="fileInput" accept=".kmplaylist"><br><br>

    <label>Temps théorique total (minutes) :</label>
    <input type="number" id="theoreticalTime" value="180"><br>
    <label>Nombre d'utilisateurs théorique :</label>
    <input type="number" id="theoreticalUsers" value="15"><br><br>

    <label>Rechercher un karaoké :</label>
    <input type="text" id="searchInput" placeholder="Titre ou artiste..."><br><br>

    <div class="multi-user-line">
        <label>Diviser durée par nombre de personnes pour :</label>
        <select id="multiUserSelect"></select>
        <input type="number" id="multiUsers" value="2" min="1">
        <button id="recalcBtn">Calculer le temps</button>
    </div>

    <button id="toggleAllBtn">Tout dérouler</button><br><br>
    <div id="playlistOutput"></div>

    <script>
        let playlistData = null;

        document.getElementById('fileInput').addEventListener('change', evt => {
            const file = evt.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    playlistData = JSON.parse(e.target.result);
                    const playlistTitle = playlistData.PlaylistInformation.name || "Playlist Karaoke Mugen";
                    document.title = playlistTitle;
                    document.querySelector('h1').textContent = playlistTitle;
                    const description = playlistData.PlaylistInformation.description || "";
                    document.getElementById('playlistDescription').textContent = description;
                    remplirSelectUsers();
                    afficherPlaylist();
                } catch (err) { console.error(err); alert('Erreur : fichier JSON invalide'); }
            };
            reader.readAsText(file);
        });

        document.getElementById('searchInput').addEventListener('input', afficherPlaylist);
        document.getElementById('recalcBtn').addEventListener('click', afficherPlaylist);

        function getKaraokesFromPlaylist(data) {
            for (const key in data) { if (Array.isArray(data[key]) && data[key][0]?.kid) return data[key]; }
            return [];
        }

        function getAllUsers(data) {
            const set = new Set();
            getKaraokesFromPlaylist(data).forEach(k => set.add(k.nickname || "Inconnu"));
            data.PlaylistInformation?.contributors?.forEach(c => set.add(c.nickname));
            return [...set];
        }

        function remplirSelectUsers() {
            const select = document.getElementById('multiUserSelect');
            select.innerHTML = '';
            const emptyOpt = document.createElement('option');
            emptyOpt.value = ''; emptyOpt.textContent = '-- aucun --'; emptyOpt.selected = true;
            select.appendChild(emptyOpt);
            getAllUsers(playlistData).forEach(u => {
                const opt = document.createElement('option'); opt.value = u; opt.textContent = u; select.appendChild(opt);
            });
            select.value = '';
        }

        function afficherPlaylist() {
            if (!playlistData) return;
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const karaList = getKaraokesFromPlaylist(playlistData)
                .filter(k => {
                    const title = k.titles?.eng || k.titles?.jpn || "Sans titre";
                    const artists = k.singers?.map(s => s.name).join(", ") || "";
                    return title.toLowerCase().includes(searchQuery) || artists.toLowerCase().includes(searchQuery);
                });

            const container = document.getElementById('playlistOutput');
            container.innerHTML = '';

            const totalPlaylist = karaList.reduce((s, k) => s + (k.duration || 0), 0);
            const totalDiv = document.createElement('div');
            totalDiv.innerHTML = `<b>Temps total :</b> ${Math.floor(totalPlaylist / 60)}:${String(totalPlaylist % 60).padStart(2, '0')} (${karaList.length} karaokés)`;
            container.appendChild(totalDiv);

            const theoreticalTime = (+document.getElementById('theoreticalTime').value || 180) * 60;
            const theoreticalUsers = +document.getElementById('theoreticalUsers').value || 15;
            const timePerUser = theoreticalTime / theoreticalUsers;
            const theoreticalDiv = document.createElement('div');
            theoreticalDiv.innerHTML = `<b>Temps théorique par utilisateur :</b> ${Math.floor(timePerUser / 60)}:${String(Math.floor(timePerUser % 60)).padStart(2, '0')} pour ${theoreticalUsers} utilisateurs<br><br>`;
            container.appendChild(theoreticalDiv);

            const multiUser = document.getElementById('multiUserSelect').value;
            const multiUsers = +document.getElementById('multiUsers').value || 1;

            const users = {};
            getAllUsers(playlistData).forEach(u => users[u] = { total: 0, songs: [], totalSongs: 0 });
            karaList.forEach(k => { const u = k.nickname || "Inconnu"; users[u].total += k.duration || 0; users[u].totalSongs += 1; users[u].songs.push(k); });

            const userEntries = [];
            Object.entries(users).forEach(([user, data]) => {
                if (multiUser && user === multiUser && multiUsers > 1) {
                    const sharedDuration = data.total / multiUsers, sharedSongs = data.totalSongs / multiUsers;
                    userEntries.push([user, { total: data.total - sharedDuration, songs: [], totalSongs: data.totalSongs - sharedSongs }]);
                    userEntries.push([`${user} (partagé)`, { total: sharedDuration, songs: data.songs, totalSongs: sharedSongs }]);
                } else { userEntries.push([user, data]); }
            });

            userEntries.sort((a, b) => b[1].total - a[1].total || b[1].totalSongs - a[1].totalSongs || a[0].localeCompare(b[0]));

            userEntries.forEach(([user, data], index) => {
                const userDiv = document.createElement('div'); userDiv.className = 'user-section';

                let cls = 'ok'; if (data.total === 0) cls = 'zero'; else if (data.total > timePerUser) cls = 'over';

                const headerDiv = document.createElement('div'); headerDiv.className = 'user-header';

                const toggleBtn = document.createElement('button'); toggleBtn.className = 'toggle-btn'; toggleBtn.textContent = '▶';

                const span = document.createElement('span'); span.className = cls;
                span.textContent = ` ${user} - ${Math.floor(data.total / 60)}:${String(data.total % 60).padStart(2, '0')} (${Math.round(data.totalSongs)} karaokés)`;

                headerDiv.appendChild(toggleBtn); headerDiv.appendChild(span); userDiv.appendChild(headerDiv);

                const karaContainer = document.createElement('div'); karaContainer.className = 'kara-container'; karaContainer.style.display = 'none';

                data.songs.forEach(k => {
                    const karaItem = document.createElement('div'); karaItem.className = 'kara-item';
                    const title = k.titles?.eng || k.titles?.qro || k.titles?.jpn || "Sans titre";
                    const artists = k.singers?.map(s => s.name).join(", ") || "Artiste inconnu";
                    const types = (k.songtypes || []).map(t => `<span class="tag">${t.name}</span>`).join(" ");
                    const versions = (k.versions || []).map(v => `<span class="version-tag">${v.name}</span>`).join(" ");
                    karaItem.innerHTML = `<div class="kara-title">${title} ${versions}</div>
            <div class="kara-info">${artists} - ${Math.floor(k.duration / 60)}:${String(k.duration % 60).padStart(2, '0')} | Types: ${types}</div>`;
                    karaContainer.appendChild(karaItem);
                });

                userDiv.appendChild(karaContainer);

                toggleBtn.addEventListener('click', e => {
                    e.stopPropagation();
                    if (karaContainer.style.display === 'none') { karaContainer.style.display = 'block'; toggleBtn.textContent = '▼'; }
                    else { karaContainer.style.display = 'none'; toggleBtn.textContent = '▶'; }
                });

                const barContainer = document.createElement('div'); barContainer.className = 'time-bar-container';
                const bar = document.createElement('div'); bar.className = 'time-bar';
                const percent = Math.min(100, (data.total / timePerUser) * 100);
                bar.style.width = percent + '%';
                bar.style.background = (data.total === 0) ? '#b0b0b0' : (data.total > timePerUser) ? '#e74c3c' : '#6abf69';
                barContainer.appendChild(bar); userDiv.appendChild(barContainer);

                container.appendChild(userDiv);
            });
        }

        document.getElementById('toggleAllBtn').addEventListener('click', () => {
                const allContainers = document.querySelectorAll('.kara-container');
                const allToggles = document.querySelectorAll('.toggle-btn');
                const anyClosed = Array.from(allContainers).some(c => c.style.display === 'none');

                allContainers.forEach((c, i) => {
                    if (anyClosed) {
                        c.style.display = 'block';
                        allToggles[i].textContent = '▼';
                    } else {
                        c.style.display = 'none';
                        allToggles[i].textContent = '▶';
                    }
                });

                document.getElementById('toggleAllBtn').textContent = anyClosed ? 'Tout replier' : 'Tout dérouler';
            });

    </script>
</body>

</html> 